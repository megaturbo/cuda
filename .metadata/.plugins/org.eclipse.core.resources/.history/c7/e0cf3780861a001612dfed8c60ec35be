#include "Indice2D.h"
#include "cudaTools.h"

#include <stdio.h>
#include <curand_kernel.h>
#include "ReduceTools.h"

/*----------------------------------------------------------------------*\
 |*			Declaration 					*|
 \*---------------------------------------------------------------------*/

/*--------------------------------------*\
 |*		Imported	 	*|
 \*-------------------------------------*/

/*--------------------------------------*\
 |*		Public			*|
 \*-------------------------------------*/

__global__ void montecarlo(curandState* ptrTabDevGeneratorGM, int* ptrDevN0, int nbFlechettes);
__global__ void setup_kernel_rand(curandState* tabGeneratorThread, int deviceId);

/*--------------------------------------*\
 |*		Private			*|
 \*-------------------------------------*/

static __device__ void reduceIntraThread(int* tabSM, curandState* ptrTabDevGeneratorGM, int nbFlechettes);
static __device__ float f(float x);
/*----------------------------------------------------------------------*\
 |*			Implementation 					*|
 \*---------------------------------------------------------------------*/

/*--------------------------------------*\
 |*		Public			*|
 \*-------------------------------------*/

/**
 * output : void required !!
 */
__global__ void montecarlo(curandState* ptrTabDevGeneratorGM, int* ptrDevN0,
		int nbFlechettes)
{
	extern __shared__ int tabSM[];
	reduceIntraThread(tabSM, ptrTabDevGeneratorGM, nbFlechettes);
	__syncthreads();
	reduceIntraBlock (tabSM);
	reduceInterBlock(tabSM, ptrDevN0);
}

__global__ void setup_kernel_rand(curandState* tabGeneratorThread, int deviceId)
{
	int tid = Indice2D::tid();
	//Customisation du generator: Proposition (au lecteur de faire mieux)
	// Contrainte : Doit etre différent d'un GPU à l'autre
	int deltaSeed = deviceId * INT_MAX;
	int deltaSequence = deviceId * 100;
	int deltaOffset = deviceId * 100;
	int seed = 1234 + deltaSeed;
	int sequenceNumber = tid + deltaSequence;
	int offset = deltaOffset;
	curand_init(seed, sequenceNumber, offset, &tabGeneratorThread[tid]);
}

/*--------------------------------------*\
 |*		Private			*|
 \*-------------------------------------*/

__device__ void reduceIntraThread(int* tabSM, curandState* ptrTabDevGeneratorGM,
		int nbFlechettes)
{
	const int NB_THREAD = Indice2D::nbThread();
	const int TID = Indice2D::tid();
	const int TID_LOCAL = Indice2D::tidLocal();
	int s = TID;

	// Global Memory -> Registre
	float sumThread = 0.0f;
	curandState localState = ptrTabDevGeneratorGM[TID];

	while (s < nbFlechettes)
	{
		float randX = curand_uniform(&localState);
		float randY = curand_uniform(&localState);
		if(randY < f(randX))
		{
			sumThread ++;
		}
		s += NB_THREAD;
	}
	tabSM[TID_LOCAL] = sum;
}

/*----------------------------------------------------------------------*\
 |*			End	 					*|
 \*---------------------------------------------------------------------*/
__device__ float f(float x)
{
	return 4.0f / (1.0f + x * x);
}
